<html>
  <head>
    <meta charset="utf-8" />
    <meta name="mobile-web-app-capable" content="no" />
    <link rel="stylesheet" href="main.css" />
    <link rel="icon" href="#" />
    <title>Conditional Focus Demo</title>
  </head>
  <body>
    <h1 style="text-align: center">Conditional Focus Demo</h1>
    <div class="centerAligned">
      <video id="video" autoplay style="border: solid; width: 50%"></video>
    </div>
    <div style="text-align: center">
      <button
        id="captureAndFocusButton"
        onclick="onCaptureButtonClicked(true);"
        style="background: #47a119; color: #fff"
      >
        Capture and Focus
      </button>
      <button
        id="captureAndNoFocusButton"
        onclick="onCaptureButtonClicked(false);"
        style="background: #d00909; color: #fff"
      >
        Capture without Focus (NEW)
      </button>
      <div id="feature_disabled_warning" style="display: none; padding: 1%">
        <li>
          The Origin Trial on this demo might have expired. In that case, either [Experimental Web
          Platform features] or launch the browser with --enable-blink-features=ConditionalFocus.
        </li>
      </div>
      <div id="unfocusable_warning" style="display: none; padding: 1%">
        <p>
          Only tabs and windows are focusable. You seem to have chosen to share a screen. This
          option won't do much in the context of this demo. Please try a tab or a window instead.
        </p>
      </div>
    </div>
    <script>
      const video = document.getElementById("video");
      const unfocusable_warning = document.getElementById("unfocusable_warning");
      let stream; // Prevents garbage collection of the stream.

      function reset() {
        unfocusable_warning.style.display = "none";
        video.style.display = "";

        if (video.srcObject != null) {
          video.srcObject.getVideoTracks()[0].stop();
          video.srcObject = null;
        }
      }

      async function onCaptureButtonClicked(shouldFocus) {
        reset();

        try {
          const controller = new CaptureController();
          stream = await navigator.mediaDevices.getDisplayMedia({
            video: true,
            audio: true,
            controller,
          });
          const [track] = stream.getVideoTracks();

          const focusableSurfaces = ["browser", "window"];
          if (!focusableSurfaces.includes(track.getSettings().displaySurface)) {
            unfocusable_warning.style.display = "";
            video.style.display = "none";
            track.stop();
            return;
          }

          controller.setFocusBehavior(shouldFocus ? "focus-captured-surface" : "no-focus-change");
        } catch (error) {
          console.error(error);
          return;
        }

        video.srcObject = stream;
      }
    </script>
  </body>
</html>
